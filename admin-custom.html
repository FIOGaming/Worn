<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demandes Custom — QUARSOE Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">QUARSOE</a>
<nav class="header-nav">
                <a href="admin-product.html" class="nav-link">Produits</a>
                <a href="admin-orders.html" class="nav-link">Commandes</a>
                <a href="admin-opinion.html" class="nav-link">Avis</a>
                <a href="index.html" class="nav-link">Boutique</a>
            </nav>
        </div>
    </header>

    <main class="main" style="padding-top: 6rem;">
        <div class="container">
            <section class="admin-orders-page">
                <div class="orders-header">
                    <div class="orders-header-content">
                        <h1 class="orders-page-title">Demandes de Design Personnalisé</h1>
                        <div class="orders-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total</span>
                                <span class="stat-value" id="totalRequests">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">En attente</span>
                                <span class="stat-value pending" id="pendingRequests">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Acceptées</span>
                                <span class="stat-value shipped" id="approvedRequests">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="orders-toolbar">
                    <div class="search-filter-group">
                        <div class="admin-search">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            <input type="text" id="requestSearchInput" class="admin-search-input" placeholder="Rechercher...">
                        </div>
                        
                        <select id="statusFilter" class="filter-select">
                            <option value="all">Tous les statuts</option>
                            <option value="pending">En attente</option>
                            <option value="quoted">Devis envoyé</option>
                            <option value="approved">Approuvé</option>
                            <option value="in-production">En production</option>
                            <option value="completed">Terminé</option>
                            <option value="rejected">Refusé</option>
                        </select>
                    </div>
                </div>

                <div id="requestsList" class="orders-list"></div>
            </section>
        </div>
    </main>

    <div id="quoteModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeQuoteModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="modal-body" style="padding: 2rem;">
                <h2 style="font-family: var(--font-display); margin-bottom: 1.5rem;">Envoyer un Devis</h2>
                <form id="quoteForm">
                    <div class="form-group">
                        <label for="quotePrice">Prix proposé (€) *</label>
                        <input type="number" id="quotePrice" class="form-input" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="quoteDelay">Délai de fabrication *</label>
                        <input type="text" id="quoteDelay" class="form-input" placeholder="Ex: 7-10 jours" required>
                    </div>
                    <div class="form-group">
                        <label for="quoteNotes">Notes supplémentaires</label>
                        <textarea id="quoteNotes" class="form-textarea" rows="4" placeholder="Informations additionnelles pour le client..."></textarea>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">Envoyer le devis</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        emailjs.init('3KBCuFH_xY7HjM3L9');
        
        const firebase = window.firebase;
        const firebaseConfig = {
            apiKey: "AIzaSyAvSh3XI-t78INDTuq5TTq07V1wOAeEEXI",
            authDomain: "worn-4edd1.firebaseapp.com",
            databaseURL: "https://worn-4edd1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "worn-4edd1",
            storageBucket: "worn-4edd1.firebasestorage.app",
            messagingSenderId: "597648038146",
            appId: "1:597648038146:web:29b0c3ef3d4aa133180a1b"
        };

        if (!firebase.apps || !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        let allRequests = [];
        let currentRequestId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadCustomRequests();
            document.getElementById('requestSearchInput').addEventListener('input', filterRequests);
            document.getElementById('statusFilter').addEventListener('change', filterRequests);
        });

        function loadCustomRequests() {
            database.ref('customRequests').on('value', (snapshot) => {
                const data = snapshot.val();
                allRequests = data ? Object.entries(data).map(([key, val]) => ({ id: key, ...val })) : [];
                filterRequests();
            });
        }

        function filterRequests() {
            const searchTerm = document.getElementById('requestSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = allRequests.filter(req => {
                const matchesSearch = req.email?.toLowerCase().includes(searchTerm) || 
                                    req.customerName?.toLowerCase().includes(searchTerm) ||
                                    req.id?.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || req.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            displayRequests(filtered);
            updateStats(allRequests);
        }

        function updateStats(requests) {
            const total = requests.length;
            const pending = requests.filter(r => r.status === 'pending').length;
            const approved = requests.filter(r => r.status === 'approved' || r.status === 'completed').length;

            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('approvedRequests').textContent = approved;
        }

        function displayRequests(requests) {
            const list = document.getElementById('requestsList');

            if (requests.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 4rem; text-align: center;">Aucune demande trouvée</div>';
                return;
            }

            const statusLabels = {
                'pending': 'En attente',
                'quoted': 'Devis envoyé',
                'approved': 'Approuvé',
                'in-production': 'En production',
                'completed': 'Terminé',
                'rejected': 'Refusé'
            };

            list.innerHTML = requests.map(req => {
                const date = new Date(req.timestamp).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const positionLabels = {
                    'front-center': 'Devant - Centre',
                    'front-left': 'Devant - Gauche',
                    'back-center': 'Dos - Centre',
                    'back-top': 'Dos - Haut',
                    'sleeve': 'Manche'
                };

                return `
                    <div class="order-card-enhanced custom-request-card">
                        <div class="order-card-header">
                            <div class="order-number-date">
                                <span class="order-id">${req.id}</span>
                                <span class="order-date">${date}</span>
                            </div>
                            ${req.price ? `<span class="order-total-badge">${req.price}€</span>` : ''}
                        </div>
                        <div class="order-card-body">
                            <div class="custom-request-grid">
                                <div class="custom-request-image">
                                    <img src="${req.designImage}" alt="Design" style="width: 100%; height: 200px; object-fit: contain; background: var(--gray-100); border-radius: 8px;">
                                </div>
                                <div class="custom-request-details">
                                    <div class="detail-item">
                                        <strong>Client:</strong> ${req.customerName}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Email:</strong> ${req.email}
                                    </div>
                                    ${req.phone ? `<div class="detail-item"><strong>Tél:</strong> ${req.phone}</div>` : ''}
                                    <div class="detail-item">
                                        <strong>Vêtement:</strong> ${req.garmentName} - Taille ${req.size}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Couleur:</strong> <span style="display: inline-block; width: 20px; height: 20px; background: ${req.color}; border: 1px solid #ddd; border-radius: 4px; vertical-align: middle;"></span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Position:</strong> ${positionLabels[req.position] || req.position}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Description:</strong><br>${req.description}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="order-card-footer">
                            <select class="order-status-select ${req.status || 'pending'}" onchange="updateRequestStatus('${req.id}', this.value)">
                                ${Object.keys(statusLabels).map(s => `<option value="${s}" ${(req.status || 'pending') === s ? 'selected' : ''}>${statusLabels[s]}</option>`).join('')}
                            </select>
                            <div class="order-actions">
                                ${req.status === 'pending' || !req.price ? `<button class="btn-action" style="background: var(--black); color: var(--white); padding: 0.5rem 1rem; border-radius: 6px;" onclick="openQuoteModal('${req.id}')" title="Envoyer un devis">Devis</button>` : ''}
                                <button class="btn-action btn-delete-action" onclick="deleteRequest('${req.id}')" title="Supprimer">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateRequestStatus(id, status) {
            database.ref('customRequests/' + id + '/status').set(status);
        }

        function deleteRequest(id) {
            if (!confirm('Supprimer cette demande?')) return;
            database.ref('customRequests/' + id).remove();
        }

        function openQuoteModal(id) {
            currentRequestId = id;
            document.getElementById('quoteModal').classList.add('active');
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('active');
            document.getElementById('quoteForm').reset();
            currentRequestId = null;
        }

        document.getElementById('quoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const request = allRequests.find(r => r.id === currentRequestId);
            if (!request) return;

            const price = document.getElementById('quotePrice').value;
            const delay = document.getElementById('quoteDelay').value;
            const notes = document.getElementById('quoteNotes').value;

            await database.ref('customRequests/' + currentRequestId).update({
                price: price,
                delay: delay,
                quoteNotes: notes,
                status: 'quoted'
            });

            emailjs.send('service_qfzd8k8', 'template_5gmrdls', {
                to_email: request.email,
                to_name: request.customerName,
                request_id: request.id,
                garment: request.garmentName,
                price: price,
                delay: delay,
                notes: notes || 'Aucune note supplémentaire'
            }).then(() => {
                alert('Devis envoyé avec succès!');
                closeQuoteModal();
            }).catch((error) => {
                console.error('Erreur EmailJS:', error);
                alert('Le devis a été enregistré mais l\'email n\'a pas pu être envoyé.');
                closeQuoteModal();
            });
        });
    </script>
</body>
</html>
